<div class="page-container">
  <header class="header">
    <img src="assets/images/jbf-logo.svg" alt="JBF Forsikring" class="logo" />
  </header>

  <div class="intro-container">
    <div class="icon-wrapper">
      <img src="assets/icons/car.svg" alt="Bil" class="car-icon" />
    </div>

    <h1>Få pris på forsikring</h1>
    <p class="subtitle">Skriv inn registreringsnummeret for å få et pristilbud på bilforsikring.</p>

    <form (ngSubmit)="onSubmit()" class="search-form">
      <div class="input-group">
        <label for="regNumber" class="visually-hidden">Registreringsnummer</label>
        <input type="text" id="regNumber" [(ngModel)]="regInput" name="regNumber" placeholder="F.eks. AB 12345"
          class="reg-input" maxlength="8" autocomplete="off" />
      </div>
      <button type="submit" class="submit-btn" [disabled]="isLoading() || !regInput()">
        @if (isLoading()) {
        <span class="loading-spinner"></span>
        Søker...
        } @else {
        Få pris
        }
      </button>

      <button type="button" class="estimate-link" (click)="toggleEstimateForm()">
        Finner ikke bilen din?
      </button>
    </form>

    @if (showEstimateForm()) {
    <form (ngSubmit)="onEstimateSubmit()" class="estimate-form">
      <div class="input-row">
        <div class="input-field">
          <label for="make">Merke</label>
          <input id="make" [(ngModel)]="estimateMake" name="make" placeholder="F.eks. Toyota" />
        </div>
        <div class="input-field">
          <label for="model">Modell</label>
          <input id="model" [(ngModel)]="estimateModel" name="model" placeholder="F.eks. Rav4" />
        </div>
      </div>

      <div class="input-row">
        <div class="input-field">
          <label for="year">Årsmodell</label>
          <input type="number" id="year" [(ngModel)]="estimateYear" name="year" placeholder="F.eks. 2020" />
        </div>
        <div class="input-field">
          <label for="mileage">Årlig kilometerstand</label>
          <input type="number" id="mileage" [(ngModel)]="estimateMileage" name="mileage" placeholder="F.eks. 8000" />
        </div>
      </div>

      <div class="estimate-actions">
        <button type="submit" class="submit-btn estimate-submit"
          [disabled]="isEstimating() || !estimateMake() || !estimateModel() || !estimateYear() || !estimateMileage()">
          @if (isEstimating()) {
          <span class="loading-spinner"></span>
          Henter...
          } @else {
          Få estimat
          }
        </button>
        <button type="button" class="estimate-cancel" (click)="showEstimateForm.set(false)">Avbryt</button>
      </div>
    </form>
    }

    @if (error()) {
    <div class="error-card">
      <p>{{ error() }}</p>
    </div>
    }

    @if (hasSearched() && result()) {
    <div class="result-card">
      <div class="result-header">
        <span class="result-reg">{{ result()!.regNumber }}</span>
      </div>
      <div class="result-details">
        <h2 class="car-name">{{ result()!.make }} {{ result()!.model }}</h2>
        <div class="car-specs">
          <div class="spec">
            <span class="spec-label">Årsmodell</span>
            <span class="spec-value">{{ result()!.year }}</span>
          </div>
          <div class="spec">
            <span class="spec-label">Dekning</span>
            <span class="spec-value">{{ result()!.coverage }}</span>
          </div>
        </div>

        <div class="offer-details">
          <h3>Tilbudsdetaljer</h3>
          <div class="detail-row">
            <label for="bonus-select">Bonus</label>
            <select id="bonus-select" [ngModel]="selectedBonus()" (ngModelChange)="selectedBonus.set($event)"
              class="bonus-select">
              @for (option of bonusOptions; track option) {
              <option [value]="option">{{ option }} %</option>
              }
            </select>
          </div>

          <div class="detail-row">
            <label>Egenandel</label>
            <div class="detail-value">{{ formatCurrency(result()!.deductible) }}</div>
          </div>

          <div class="coverage-options">
            <h4>Tilleggsdekninger</h4>
            <ul>
              @for (opt of result()!.coverageOptions; track opt) {
              <li class="coverage-option">
                <div class="option-row">
                  <span class="option-name">{{ opt.name }}</span>
                  <span class="option-price">{{ formatPrice(opt.price) }}</span>
                </div>
                <div class="option-desc">{{ opt.description }}</div>
              </li>
              }
            </ul>
          </div>
        </div>

        <div class="price-section">
          <span class="price-label">Månedspris fra</span>
          <span class="price-value">{{ formatPrice(result()!.insurancePrice) }}</span>
          <span class="price-yearly">{{ formatYearlyPrice(result()!.insurancePrice) }}</span>
        </div>
      </div>
    </div>

    <!-- Contact Action Card -->
    @if (!contactSubmitted()) {
    <div class="action-card">
      <div class="action-card-header">
        <img src="assets/icons/phone.svg" alt="" class="action-icon" />
        <div class="action-card-title">
          <h3>Få tilbudet tilsendt</h3>
          <p>Vi kontakter deg med et komplett tilbud.</p>
        </div>
      </div>

      <form (ngSubmit)="onContactSubmit()" class="contact-form">
        <div class="input-row">
          <div class="input-field">
            <label for="phone">
              <img src="assets/icons/phone.svg" alt="" class="field-icon" />
              Telefon
            </label>
            <input type="tel" id="phone" [(ngModel)]="phoneNumber" name="phone" placeholder="Ditt telefonnummer"
              autocomplete="tel" />
          </div>
          <div class="input-field">
            <label for="email">
              <img src="assets/icons/envelope.svg" alt="" class="field-icon" />
              E-post
            </label>
            <input type="email" id="email" [(ngModel)]="email" name="email" placeholder="Din e-postadresse"
              autocomplete="email" />
          </div>
        </div>
        <button type="submit" class="contact-btn" [disabled]="isSubmittingContact() || !isContactFormValid">
          @if (isSubmittingContact()) {
          <span class="loading-spinner"></span>
          Sender...
          } @else {
          Send meg tilbudet
          }
        </button>
      </form>
    </div>
    } @else {
    <div class="success-card">
      <img src="assets/icons/check.svg" alt="" class="success-icon" />
      <h3>Takk for din henvendelse!</h3>
      <p>Vi tar kontakt med deg snart med et komplett forsikringstilbud for din {{ result()!.make }} {{ result()!.model
        }}.</p>
    </div>
    }
    }

    <p class="disclaimer">
      Prisestimatet er veiledende. Endelig pris avhenger av førers alder, bosted og kjørehistorikk.
    </p>
  </div>

  <footer class="footer">
    <img src="assets/images/jbf-logo.svg" alt="JBF Forsikring" class="footer-logo" />
    <p>JBF Forsikring AS</p>
  </footer>
</div>